<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Banking Portal — Home & Cash Deposit Kiosk</title>
<style>
  /* ---------- Base ---------- */
  :root{
    --primary:#0b5ed7; --accent:#22c55e; --bg:#071024; --card:#0b1220;
    --muted:#94a3b8; --text:#e6eef8; --danger:#ef4444; --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0f172a 0%,#071024 100%);color:var(--text);min-height:100vh}
  a{color:inherit}

  /* ---------- Header ---------- */
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:linear-gradient(90deg,var(--bg),#071327);border-bottom:1px solid rgba(255,255,255,0.02)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#60a5fa);color:#071018;font-weight:800}
  nav{display:flex;gap:18px;align-items:center}
  nav a{color:var(--muted);text-decoration:none;font-weight:600}
  nav a:hover{color:var(--text)}

  /* ---------- Layout ---------- */
  .container{max-width:1200px;margin:28px auto;padding:0 18px}
  .grid{display:grid;gap:18px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  @media(max-width:900px){ .cols-3{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:640px){ .cols-3{grid-template-columns:1fr} }

  /* ---------- Cards ---------- */
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
  h2{margin:4px 0 12px 0;font-size:20px}
  p.small{color:var(--muted);margin:6px 0}

  /* ---------- Blog cards ---------- */
  .blog-img{width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .blog-title{font-weight:700;margin:8px 0 6px 0;color:var(--text)}
  .blog-desc{color:var(--muted);font-size:14px}

  /* ---------- Services ---------- */
  .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .service-card{display:flex;flex-direction:column;gap:10px;align-items:flex-start}

  .btn{appearance:none;background:linear-gradient(135deg,var(--primary),#2563eb);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05)}
  .btn.secondary{background:linear-gradient(135deg,var(--accent),#16a34a);color:#071018}

  /* ---------- Modal / Kiosk ---------- */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .overlay.open{display:flex}
  .kiosk{width:100%;max-width:980px;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#07101a,#071727);border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(2,6,23,0.7)}
  .kiosk header{display:flex;justify-content:space-between;align-items:center;padding:18px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .steps{display:flex;gap:8px;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.02);overflow:auto}
  .step-chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-weight:700;font-size:13px}
  .step-chip.active{background:rgba(255,255,255,0.02);color:var(--text);border-color:#243246}
  .panel{padding:20px;display:grid;gap:14px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
  .denom-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:720px){ .denom-grid{grid-template-columns:repeat(2,1fr)} }
  .denom{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:6px}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .summary{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .code-badge{font-family:ui-monospace,monospace;padding:8px 12px;border-radius:10px;background:#020617;border:1px dashed #334155;display:inline-flex;gap:12px;align-items:center}

  .note{font-size:13px;color:var(--muted)}

  /* small helpers */
  .muted{color:var(--muted)} .right{display:flex;align-items:center;gap:10px}
  footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}
  /* ensure auth overlay above kiosk */
  #authOverlay{z-index:80}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">₹</div>
    <div>
      <div style="font-weight:800;font-size:18px">SmartBank</div>
      <div class="muted" style="font-size:12px">Secure • Fast • Assisted</div>
    </div>
  </div>
  <nav>
    <a href="#blogs">Blogs</a>
    <a href="#services">Services</a>
    <span id="userGreeting" style="display:none;color:var(--muted);font-weight:600"></span>
    <button class="btn ghost" id="authBtn">Login / Sign Up</button>
  </nav>
</header>

<main class="container">
  <!-- Blogs -->
  <section id="blogs" class="card" style="margin-bottom:18px">
    <h2>Latest Blogs</h2>
    <div class="grid cols-3" style="align-items:start">
      <article class="card blog-card">
        <img src="./img.png" alt="" class="blog-img">
        <div class="blog-title">Smart Banking Tips</div>
        <div class="blog-desc">Practical tips to keep your money safe and make banking easier.</div>
      </article>
      <article class="card blog-card">
        <img src="./img2.png" alt="" class="blog-img">
        <div class="blog-title">Digital Payments in India</div>
        <div class="blog-desc">Overview of UPI, mobile wallets, and secure digital payments.</div>
      </article>
      <article class="card blog-card">
        <img src="img3.png" alt="" class="blog-img">
        <div class="blog-title">AI in Banking</div>
        <div class="blog-desc">How AI improves customer support, fraud detection, and automation.</div>
      </article>
    </div>
  </section>

  <!-- Services -->
  <section id="services" class="card">
    <h2>Our Services</h2>
    <p class="small">We offer a suite of services powered by modern banking tech — click <strong>Start</strong> to open the Cash Deposit Kiosk flow.</p>

    <div class="services-grid">
      <div class="card service-card">
        <div style="font-weight:800">Cash Deposit Kiosk</div>
        <div class="muted">Fast, assisted cash deposit with time-sensitive verification code.</div>
        <div style="margin-top:auto;width:100%;display:flex;justify-content:flex-end">
          <button class="btn" id="startDepositBtn">Start Deposit</button>
        </div>
      </div>

      <div class="card service-card">
        <div style="font-weight:800">ICR-based Slip Processing</div>
        <div class="muted">Scan and extract account/amount data from bank slips using ICR/Tesseract + LSTM.</div>
      </div>

      <div class="card service-card">
        <div style="font-weight:800">AI Transaction Assistant</div>
        <div class="muted">Conversational assistant to guide transactions and convert natural queries to actions (GenQuery style).</div>
      </div>
    </div>
  </section>
</main>

<!-- Auth overlay -->
<div class="overlay" id="authOverlay" aria-hidden="true">
  <div class="kiosk" style="max-width:520px" role="dialog" aria-modal="true" aria-label="User Authentication">
    <header>
      <div style="font-weight:800">Account Access</div>
      <div class="right">
        <button class="btn ghost" id="closeAuth">Close</button>
      </div>
    </header>
    <div class="panel" style="padding-top:10px">
      <div style="display:flex;gap:10px;margin-bottom:6px">
        <button class="btn secondary" id="showLogin" style="flex:1">Login</button>
        <button class="btn ghost" id="showSignup" style="flex:1">Sign Up</button>
      </div>
      <!-- LOGIN FORM -->
      <form id="loginForm" autocomplete="off" style="display:grid;gap:12px">
        <div>
          <label for="login_email">Email</label>
          <input id="login_email" type="email" placeholder="you@mail.com" required>
        </div>
        <div>
          <label for="login_pass">4-Digit Passcode</label>
          <input id="login_pass" type="password" inputmode="numeric" maxlength="4" placeholder="••••" required>
        </div>
        <div id="loginErr" class="note" style="color:var(--danger);display:none"></div>
        <button class="btn" type="submit">Login</button>
        <div class="note">Don't have an account? <a href="#" id="lnkToSignup" style="color:var(--accent);text-decoration:none">Sign up</a></div>
      </form>
      <!-- SIGNUP FORM -->
      <form id="signupForm" autocomplete="off" style="display:none;gap:12px">
        <div>
          <label for="su_name">Full Name</label>
          <input id="su_name" placeholder="A. Kumar" required>
        </div>
        <div>
          <label for="su_email">Email</label>
          <input id="su_email" type="email" placeholder="you@mail.com" required>
        </div>
        <div>
          <label for="su_phone">Mobile Number (10 digits)</label>
          <input id="su_phone" type="tel" inputmode="numeric" maxlength="10" placeholder="9876543210" required>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label for="su_pass">Passcode (4 digits)</label>
            <input id="su_pass" type="password" inputmode="numeric" maxlength="4" placeholder="1234" required>
          </div>
          <div>
            <label for="su_pass2">Confirm</label>
            <input id="su_pass2" type="password" inputmode="numeric" maxlength="4" placeholder="1234" required>
          </div>
        </div>
        <div id="signupErr" class="note" style="color:var(--danger);display:none"></div>
        <button class="btn secondary" type="submit">Create Account</button>
        <div class="note">Already have an account? <a href="#" id="lnkToLogin" style="color:var(--accent);text-decoration:none">Login</a></div>
        <div class="note" style="margin-top:4px">Demo only: data is stored locally in your browser.</div>
      </form>
    </div>
  </div>
</div>

<!-- Kiosk overlay (page-wise inside) -->
<div class="overlay" id="overlay">
  <div class="kiosk" role="dialog" aria-modal="true" aria-label="Cash Deposit Kiosk">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:800">Cash Deposit Kiosk</div>
        <div class="muted" style="font-size:13px">Follow the guided steps</div>
      </div>
      <div class="right">
        <button class="btn ghost" id="closeOverlay">Close</button>
      </div>
    </header>

    <div class="steps" id="stepChips" aria-hidden>
      <div class="step-chip active" data-step="1">1. Details</div>
      <div class="step-chip" data-step="2">2. Denominations</div>
      <div class="step-chip" data-step="3">3. Confirm</div>
      <div class="step-chip" data-step="4">4. Code</div>
      <div class="step-chip" data-step="5">5. Complete</div>
    </div>

    <main class="panel">
      <!-- PAGE 1: Details (Account + IFSC immediate + Name) -->
      <section id="page-1" class="page">
        <div id="loginPrompt" class="note" style="display:none;margin-bottom:8px"></div>
        <div style="display:grid;gap:10px">
          <div>
            <label for="k_account">Account Number</label>
            <input id="k_account" inputmode="numeric" placeholder="e.g., 123456789012" autocomplete="off">
            <div id="accErr" class="note" style="color:var(--danger);display:none"></div>
          </div>
          <div>
            <label for="k_ifsc">IFSC Code</label>
            <input id="k_ifsc" maxlength="11" placeholder="e.g., HDFC0AB1234" autocomplete="off" style="text-transform:uppercase">
            <div id="ifscErr" class="note" style="color:var(--danger);display:none"></div>
          </div>
          <div>
            <label for="k_name">Account Holder Name</label>
            <input id="k_name" placeholder="e.g., A. Kumar">
            <div id="nameErr" class="note" style="color:var(--danger);display:none"></div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="p1_reset">Reset</button>
          <button class="btn" id="toDenom">Continue</button>
        </div>
      </section>

      <!-- PAGE 2: Denominations -->
      <section id="page-2" class="page" hidden>
        <div>
          <p class="note">Select quantity for each denomination. Totals calculate automatically.</p>
          <div class="denom-grid" id="denomGrid"></div>
          <div class="summary" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Grand Total</div>
            <div style="font-weight:800" id="grandTotal">₹0</div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="backTo1">Back</button>
          <button class="btn" id="toConfirm">Review & Confirm</button>
        </div>
      </section>

      <!-- PAGE 3: Confirm -->
      <section id="page-3" class="page" hidden>
        <div class="summary" id="confirmSummary" aria-live="polite"></div>
        <div class="note">Please verify details. After confirm, a unique code (valid 5 minutes) will be generated and sent to your registered phone & email.</div>
        <div class="toolbar">
          <button class="btn ghost" id="backTo2">Back</button>
          <button class="btn secondary" id="confirmBtn">Confirm & Generate Code</button>
        </div>
      </section>

      <!-- PAGE 4: Code & Notification -->
      <section id="page-4" class="page" hidden>
        <p class="note">Share this unique code with bank staff to verify the deposit. Code valid for <strong>5 minutes</strong>.</p>
        <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
          <div>
            <div class="code-badge">
              <div>Code:</div>
              <div id="uniqCode" style="font-weight:900">— — — —</div>
              <div id="countdown" style="margin-left:12px;font-weight:800">05:00</div>
            </div>
            <div style="margin-top:10px" class="note">After expiry, you'll need to restart the process.</div>
          </div>
          <div>
            <div class="summary">
              <div style="font-weight:700;margin-bottom:6px">Notification Status</div>
              <div>SMS to: <span id="maskedPhone">+91-XXXXXX0000</span> — <span id="smsState">sending…</span></div>
              <div>Email to: <span id="maskedEmail">u*@mail.com</span> — <span id="emailState">sending…</span></div>
              <div class="note" style="margin-top:8px">(Demo) Replace sendSms() and sendEmail() stubs with your provider calls.</div>
            </div>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn ghost" id="backTo3">Back</button>
          <button class="btn" id="toComplete">Proceed</button>
        </div>
      </section>

      <!-- PAGE 5: Complete -->
      <section id="page-5" class="page" hidden>
        <div class="summary">
          <p style="margin:0"><strong>Show the code to bank staff</strong> to verify and process deposit.</p>
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;padding:8px 0"><div>Code</div><div id="finalCode">—</div></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0"><div>Amount</div><div id="finalAmount">₹0</div></div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="newTxn">New Transaction</button>
          <button class="btn" id="closeAndDone">Done</button>
        </div>
      </section>
    </main>

  </div>
</div>

<footer>© <span id="yr"></span> SmartBank — Secure Kiosk</footer>

<script>
/* ---------- Config ---------- */
const BACKEND_URL = 'http://127.0.0.1:5000'; // Flask backend base

const q = s => document.querySelector(s);
const qa = s => Array.from(document.querySelectorAll(s));

/* ---------- Elements & state ---------- */
const overlay = q('#overlay');
const startDepositBtn = q('#startDepositBtn');
// Auth elements
const authOverlay = q('#authOverlay');
const authBtn = q('#authBtn');
const closeAuth = q('#closeAuth');
const showLoginBtn = q('#showLogin');
const showSignupBtn = q('#showSignup');
const loginForm = q('#loginForm');
const signupForm = q('#signupForm');
const userGreeting = q('#userGreeting');

const stepChips = qa('.step-chip');
const pages = {
  1: q('#page-1'),
  2: q('#page-2'),
  3: q('#page-3'),
  4: q('#page-4'),
  5: q('#page-5'),
};

let currentStep = 1;
const state = {
  accountNumber: '',
  ifsc: '',
  name: '',
  denoms: [500,200,100,50,20,10],
  qty: {},
  code: null,
  expiry: null,
  timerId: null
};

// pending action (used if user asked to login while confirming)
let pendingAction = null;

/* ---------- Storage / demo auth ---------- */
function storageAvailable(){
  try {
    const k = '__sb_test__';
    localStorage.setItem(k, '1');
    localStorage.removeItem(k);
    return true;
  } catch(e){ return false; }
}
const HAS_STORAGE = storageAvailable();
let memoryUser = null;

// user object cached in memory after login/signup
let currentUser = null;
function loadUser(){ return currentUser; }
function saveUser(u){ currentUser = u; updateAuthUI(); }
function clearUser(){ currentUser = null; updateAuthUI(); }

/* ---------- Auth UI ---------- */
function updateAuthUI(){
  const u = loadUser();
  if(u){
    if(authBtn) authBtn.style.display = 'none';
    userGreeting.style.display = 'inline';
    userGreeting.innerHTML = `Hi, <strong>${(u.name||'User').split(/\s+/)[0]}</strong> <button id="logoutBtn" class="btn ghost" style="margin-left:8px">Logout</button>`;
    setTimeout(()=> {
      const lb = q('#logoutBtn');
      if(lb) lb.addEventListener('click', ()=> { clearUser(); });
    }, 0);
  } else {
    if(authBtn) authBtn.style.display = 'inline-block';
    userGreeting.style.display = 'none';
  }
}
updateAuthUI();

function openAuth(mode = 'login'){
  if(overlay) overlay.classList.remove('open');
  authOverlay.classList.add('open');
  switchMode(mode);
  setTimeout(()=> {
    const el = (mode === 'login' ? q('#login_email') : q('#su_name'));
    if(el) el.focus();
  }, 100);
}
function closeAuthModal(){
  authOverlay.classList.remove('open');
}
function switchMode(mode){
  if(mode === 'login'){
    loginForm.style.display = 'grid';
    signupForm.style.display = 'none';
    showLoginBtn.classList.add('secondary'); showLoginBtn.classList.remove('ghost');
    showSignupBtn.classList.add('ghost'); showSignupBtn.classList.remove('secondary');
  } else {
    signupForm.style.display = 'grid';
    loginForm.style.display = 'none';
    showSignupBtn.classList.add('secondary'); showSignupBtn.classList.remove('ghost');
    showLoginBtn.classList.add('ghost'); showLoginBtn.classList.remove('secondary');
  }
}

/* ---------- Validation ---------- */
function validateAcc(num){ return /^\d{9,18}$/.test(num); }
function validateIFSC(code){ return /^[A-Z]{4}0[A-Z0-9]{6}$/.test(code); }
function validateName(n){ return /^(?=.{2,100}$)[A-Za-z][A-Za-z .'-]*$/.test(n.trim()); }

/* ---------- Denoms UI ---------- */
function renderDenoms(){
  const grid = q('#denomGrid');
  if(!grid) return;
  grid.innerHTML = '';
  state.denoms.forEach(d => {
    const div = document.createElement('div');
    div.className = 'denom';
    div.innerHTML = `<div style="font-weight:700">₹${d}</div>
      <div class="note">Quantity</div>
      <input type="number" min="0" value="${state.qty[d]||0}" data-denom="${d}" aria-label="Quantity for ₹${d}">`;
    grid.appendChild(div);
  });
  updateTotals();
}
function updateTotals(){
  let total = 0;
  state.denoms.forEach(d => { const qv = Number(state.qty[d] || 0); total += d * qv; });
  const totalStr = `₹${total.toLocaleString('en-IN')}`;
  const grand = q('#grandTotal');
  const final = q('#finalAmount');
  if(grand) grand.textContent = totalStr;
  if(final) final.textContent = totalStr;
}

/* ---------- Code generation ---------- */
function luhnChecksum(numStr){
  let sum=0, dbl=false;
  for(let i=numStr.length-1;i>=0;i--){
    let n = parseInt(numStr[i],10);
    if(dbl){ n *= 2; if(n > 9) n -= 9; }
    sum += n;
    dbl = !dbl;
  }
  return (10 - (sum % 10)) % 10;
}
function genCode(){
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let base = Array.from({length:7}, ()=> alphabet[Math.floor(Math.random()*alphabet.length)]).join('');
  const digits = base.split('').map(ch => (alphabet.indexOf(ch) % 10)).join('');
  const chk = luhnChecksum(digits);
  return base + chk;
}

/* ---------- Countdown ---------- */
function startCountdown(ms = 5*60*1000){
  const cd = q('#countdown');
  if(state.timerId) clearInterval(state.timerId);
  const end = Date.now() + ms;
  state.expiry = end;
  function tick(){
    const left = Math.max(0, end - Date.now());
    const m = String(Math.floor(left/60000)).padStart(2,'0');
    const s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
    if(cd) cd.textContent = `${m}:${s}`;
    if(left <= 0){ clearInterval(state.timerId); if(cd) cd.textContent = 'Expired'; const uc = q('#uniqCode'); if(uc) uc.style.opacity = 0.6; }
  }
  tick();
  state.timerId = setInterval(tick, 1000);
}

/* ---------- Masking ---------- */
function maskPhone(num = "+91-9876540000"){
  try {
    return num.replace(/(\+?\d{1,2}-?)?(\d{4})(\d{3})(\d{3})/, (_,p,a,b,c) => `${p||''}${'X'.repeat(4)}${'X'.repeat(3)}${c}`);
  } catch(e){ return num; }
}
function maskEmail(email = "user@example.com"){
  try {
    const [u,d] = email.split('@');
    return `${u.slice(0, Math.min(3,u.length))}${'*'.repeat(Math.max(0,u.length-3))}@${d}`;
  } catch(e){ return email; }
}


/* ---------- Flow control / actions ---------- */
function openKiosk(){
  if(overlay) overlay.classList.add('open');
  showStep(1);
}
function closeKiosk(){
  if(overlay) overlay.classList.remove('open');
  resetAll();
}
function showStep(n){
  currentStep = n;
  Object.values(pages).forEach(p => { if(p) p.hidden = true; });
  if(pages[n]) pages[n].hidden = false;
  stepChips.forEach(ch => ch.classList.toggle('active', Number(ch.dataset.step) === n));
  const input = pages[n] ? pages[n].querySelector('input') : null;
  if(input) input.focus();

  // show login prompt on details page if not authed
  if(n === 1){
    const u = loadUser();
    const lp = q('#loginPrompt');
    if(!u && lp){
      lp.style.display = 'block';
      lp.innerHTML = 'Not logged in: <a href="#" id="promptLoginLink" style="color:var(--accent);text-decoration:none;font-weight:600">Login</a> or <a href="#" id="promptSignupLink" style="color:var(--accent);text-decoration:none;font-weight:600">Sign Up</a> to receive verification codes.';
      setTimeout(()=> {
        const pll = q('#promptLoginLink');
        const psl = q('#promptSignupLink');
        if(pll) pll.addEventListener('click', e => { e.preventDefault(); openAuth('login'); });
        if(psl) psl.addEventListener('click', e => { e.preventDefault(); openAuth('signup'); });
      }, 0);
    } else if(lp) {
      lp.style.display = 'none';
    }
  }
}

/* ---------- Event wiring ---------- */
q('#yr').textContent = new Date().getFullYear();

// open kiosk from page button
if(startDepositBtn) startDepositBtn.addEventListener('click', openKiosk);

// auth events
if(authBtn) authBtn.addEventListener('click', () => openAuth('login'));
if(closeAuth) closeAuth.addEventListener('click', () => { closeAuthModal(); pendingAction = null; });
if(showLoginBtn) showLoginBtn.addEventListener('click', () => switchMode('login'));
if(showSignupBtn) showSignupBtn.addEventListener('click', () => switchMode('signup'));
q('#lnkToSignup')?.addEventListener('click', e => { e.preventDefault(); switchMode('signup'); });
q('#lnkToLogin')?.addEventListener('click', e => { e.preventDefault(); switchMode('login'); });

// login submit (calls Flask /api/login)
loginForm?.addEventListener('submit', async e => {
  e.preventDefault();
  const email = q('#login_email').value.trim().toLowerCase();
  const pass = q('#login_pass').value.trim();
  const err = q('#loginErr');
  if(err){ err.style.display='none'; }
  try {
    const res = await fetch(`${BACKEND_URL}/api/login`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, passcode: pass })
    });
    const data = await res.json();
    if(!res.ok){
      if(err){ err.style.display='block'; err.textContent = data.error==='no_user' ? 'User not found.' : (data.error==='bad_creds' ? 'Invalid credentials.' : 'Login failed'); }
      return;
    }
    saveUser(data.user);
    closeAuthModal();
    if(pendingAction === 'generateCode'){ pendingAction=null; generateAndSendCode(); }
    else if(pendingAction === 'openKiosk'){ pendingAction=null; openKiosk(); }
  } catch(ex){ if(err){ err.style.display='block'; err.textContent='Network error.'; } }
});

// signup submit (calls Flask /api/signup)
signupForm?.addEventListener('submit', async e => {
  e.preventDefault();
  const name = q('#su_name').value.trim();
  const email = q('#su_email').value.trim().toLowerCase();
  const phone = q('#su_phone').value.trim();
  const pass = q('#su_pass').value.trim();
  const pass2 = q('#su_pass2').value.trim();
  const errEl = q('#signupErr');
  if(errEl) errEl.style.display='none';
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ if(errEl){ errEl.style.display='block'; errEl.textContent='Invalid email.'; } return; }
  if(!/^\d{10}$/.test(phone)){ if(errEl){ errEl.style.display='block'; errEl.textContent='Phone must be 10 digits.'; } return; }
  if(!/^\d{4}$/.test(pass)){ if(errEl){ errEl.style.display='block'; errEl.textContent='Passcode must be 4 digits.'; } return; }
  if(pass !== pass2){ if(errEl){ errEl.style.display='block'; errEl.textContent='Passcodes do not match.'; } return; }
  try {
    const res = await fetch(`${BACKEND_URL}/api/signup`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, email, phone, passcode: pass })
    });
    const data = await res.json();
    if(!res.ok){
      if(errEl){ errEl.style.display='block'; errEl.textContent = data.error==='exists' ? 'User already exists.' : 'Signup failed'; }
      return;
    }
    // After signup, prefill login
    switchMode('login');
    q('#login_email').value = email;
    q('#login_pass').focus();
  } catch(ex){ if(errEl){ errEl.style.display='block'; errEl.textContent='Network error.'; } }
});

/* ---------- Page navigation buttons ---------- */
q('#p1_reset')?.addEventListener('click', resetAll);

q('#toDenom')?.addEventListener('click', () => {
  const acc = q('#k_account').value.trim();
  const ifsc = q('#k_ifsc').value.trim().toUpperCase();
  const name = q('#k_name').value.trim();

  let ok = true;
  if(!validateAcc(acc)){ q('#accErr').style.display='block'; q('#accErr').textContent='Enter 9–18 digits.'; ok=false; } else { q('#accErr').style.display='none'; }
  if(!validateIFSC(ifsc)){ q('#ifscErr').style.display='block'; q('#ifscErr').textContent='Invalid IFSC (eg HDFC0AB1234).'; ok=false; } else { q('#ifscErr').style.display='none'; }
  if(!validateName(name)){ q('#nameErr').style.display='block'; q('#nameErr').textContent='Enter a valid name.'; ok=false; } else { q('#nameErr').style.display='none'; }

  if(!ok) return;
  state.accountNumber = acc; state.ifsc = ifsc; state.name = name;
  renderDenoms();
  showStep(2);
});

q('#backTo1')?.addEventListener('click', () => showStep(1));
q('#backTo2')?.addEventListener('click', () => showStep(2));
q('#backTo3')?.addEventListener('click', () => showStep(3));

document.addEventListener('input', (e) => {
  const el = e.target;
  if(el && el.dataset && el.dataset.denom){
    const d = Number(el.dataset.denom);
    let v = Math.max(0, Math.floor(Number(el.value || 0)));
    el.value = v;
    state.qty[d] = v;
    updateTotals();
  }
});

q('#toConfirm')?.addEventListener('click', () => {
  const total = Object.entries(state.qty).reduce((s,[d,qv]) => s + (Number(d) * Number(qv||0)), 0);
  if(total <= 0){ alert('Please add at least one note to continue.'); return; }
  const breakdown = state.denoms.filter(d => (state.qty[d] || 0) > 0)
    .map(d => `₹${d} × ${state.qty[d]} = ₹${(d * state.qty[d]).toLocaleString('en-IN')}`)
    .join('<br>') || '<em>No notes selected</em>';

  q('#confirmSummary').innerHTML = `
    <div style="display:grid;gap:8px">
      <div><span class="muted">Account:</span> <strong>${state.accountNumber}</strong></div>
      <div><span class="muted">IFSC:</span> <strong>${state.ifsc}</strong></div>
      <div><span class="muted">Name:</span> <strong>${state.name}</strong></div>
      <div><span class="muted">Breakdown:</span><div style="margin-top:6px">${breakdown}</div></div>
      <div class="note">By confirming you agree the details are correct.</div>
    </div>`;
  showStep(3);
});

/* ---------- Generate code & send notifications (wrapped) ---------- */
async function generateAndSendCode(){
  // create the code & countdown
  state.code = genCode();
  q('#uniqCode').textContent = state.code;
  startCountdown(5*60*1000);

  const user = loadUser();
  const phone = user ? (`+91-${user.phone}`) : '+91-XXXXXX0000';
  const email = user ? user.email : 'user@example.com';

  q('#maskedPhone').textContent = maskPhone(phone);
  q('#maskedEmail').textContent = maskEmail(email);
  q('#smsState').textContent = 'n/a';
  q('#emailState').textContent = 'removed';

  showStep(4);

  // Calculate amount
  const total = Object.entries(state.qty).reduce((s,[d,qv]) => s + (Number(d)*Number(qv||0)), 0);

  // email removed so no sending; leave code on screen only
  // (email send removed)
}

/* ---------- Confirm button (requires login to send code) ---------- */
q('#confirmBtn')?.addEventListener('click', async () => {
  const user = loadUser();
  if(!user){
    // request login and mark pending action
    pendingAction = 'generateCode';
    openAuth('login');
    return;
  }
  // logged-in -> generate and send immediately
  await generateAndSendCode();
});

q('#toComplete')?.addEventListener('click', () => {
  q('#finalCode').textContent = state.code || '—';
  const total = Object.entries(state.qty).reduce((s,[d,qv]) => s + (Number(d)*Number(qv||0)), 0);
  q('#finalAmount').textContent = `₹${total.toLocaleString('en-IN')}`;
  showStep(5);
});

q('#newTxn')?.addEventListener('click', resetAll);
q('#closeAndDone')?.addEventListener('click', () => { if(overlay) overlay.classList.remove('open'); resetAll(); });

q('#closeOverlay')?.addEventListener('click', () => { closeKiosk(); });

/* ---------- Reset ---------- */
function resetAll(){
  state.accountNumber = '';
  state.ifsc = '';
  state.name = '';
  state.qty = {};
  state.code = null;
  state.expiry = null;
  if(state.timerId) clearInterval(state.timerId);
  if(q('#k_account')) q('#k_account').value = '';
  if(q('#k_ifsc')) q('#k_ifsc').value = '';
  if(q('#k_name')) q('#k_name').value = '';
  if(q('#uniqCode')) q('#uniqCode').textContent = '— — — —';
  if(q('#countdown')) q('#countdown').textContent = '05:00';
  if(q('#smsState')) q('#smsState').textContent = 'n/a';
  if(q('#emailState')) q('#emailState').textContent = 'sending…';
  if(q('#maskedPhone')) q('#maskedPhone').textContent = '+91-XXXXXX0000';
  if(q('#maskedEmail')) q('#maskedEmail').textContent = 'u*@mail.com';
  renderDenoms();
  showStep(1);
}

/* ---------- Init ---------- */
renderDenoms();
showStep(1);

// Escape key closes overlays
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    authOverlay.classList.remove('open');
    if(overlay) overlay.classList.remove('open');
  }
});
</script>

</body>
</html>

